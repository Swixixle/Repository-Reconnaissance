{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "TargetHowto",
  "description": "Operator manual for the target system, with evidence-cited steps and completeness scoring",
  "type": "object",
  "required": ["prereqs", "install_steps", "config", "run_dev", "unknowns", "completeness"],
  "properties": {
    "prereqs": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Tools/runtimes needed to build and run"
    },
    "install_steps": {
      "type": "array",
      "items": { "$ref": "#/definitions/step_with_evidence" },
      "description": "Ordered installation steps with commands and evidence"
    },
    "config": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "purpose"],
        "properties": {
          "name": { "type": "string" },
          "purpose": { "type": "string" },
          "evidence": { "$ref": "#/definitions/evidence_or_null" }
        }
      },
      "description": "Configuration variables/files with purposes"
    },
    "run_dev": {
      "type": "array",
      "items": { "$ref": "#/definitions/step_with_evidence" },
      "description": "Steps to run in development mode"
    },
    "run_prod": {
      "type": "array",
      "items": { "$ref": "#/definitions/step_with_evidence" },
      "description": "Steps to run in production"
    },
    "usage_examples": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["description"],
        "properties": {
          "description": { "type": "string" },
          "command": { "type": ["string", "null"] }
        }
      }
    },
    "verification_steps": {
      "type": "array",
      "items": { "$ref": "#/definitions/step_with_evidence" },
      "description": "Steps to verify system is working"
    },
    "common_failures": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "symptom": { "type": "string" },
          "cause": { "type": "string" },
          "fix": { "type": "string" }
        }
      }
    },
    "unknowns": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["what_is_missing", "why_it_matters", "what_evidence_needed"],
        "properties": {
          "what_is_missing": { "type": "string" },
          "why_it_matters": { "type": "string" },
          "what_evidence_needed": { "type": "string" }
        }
      },
      "description": "Items that could not be determined from evidence"
    },
    "missing_evidence_requests": {
      "type": "array",
      "items": { "type": "string" }
    },
    "replit_execution_profile": {
      "type": ["object", "null"],
      "description": "Mandatory for Replit mode. Contains run_command, language, port_binding, required_secrets, external_apis, deployment_assumptions, observability, limitations.",
      "properties": {
        "run_command": { "type": ["string", "null"] },
        "language": { "type": ["string", "null"] },
        "port_binding": {
          "type": ["object", "null"],
          "properties": {
            "port": { "type": ["integer", "null"] },
            "binds_all_interfaces": { "type": "boolean" },
            "uses_env_port": { "type": "boolean" },
            "evidence": { "type": "array", "items": { "$ref": "#/definitions/evidence_object" } }
          }
        },
        "required_secrets": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "referenced_in": { "type": "array" }
            }
          }
        },
        "external_apis": { "type": "array" },
        "deployment_assumptions": { "type": "array", "items": { "type": "string" } },
        "observability": { "type": ["object", "null"] },
        "limitations": { "type": "array", "items": { "type": "string" } }
      }
    },
    "completeness": {
      "type": "object",
      "required": ["score", "max", "missing"],
      "properties": {
        "score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Deterministic completeness score"
        },
        "max": {
          "type": "integer",
          "const": 100
        },
        "missing": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Which categories did not earn points"
        },
        "deductions": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Score penalties applied (e.g. for unknowns)"
        },
        "notes": {
          "type": ["string", "null"]
        }
      }
    }
  },
  "definitions": {
    "evidence_object": {
      "type": "object",
      "required": ["path", "line_start", "line_end", "snippet_hash", "display"],
      "properties": {
        "path": { "type": "string" },
        "line_start": { "type": "integer", "minimum": 0 },
        "line_end": { "type": "integer", "minimum": 0 },
        "snippet_hash": { "type": "string", "pattern": "^[a-f0-9]{12}$" },
        "display": { "type": "string" }
      }
    },
    "evidence_or_null": {
      "oneOf": [
        { "$ref": "#/definitions/evidence_object" },
        { "type": "string" },
        { "type": "null" }
      ]
    },
    "step_with_evidence": {
      "type": "object",
      "required": ["step"],
      "properties": {
        "step": { "type": "string" },
        "command": { "type": ["string", "null"] },
        "evidence": { "$ref": "#/definitions/evidence_or_null" }
      }
    }
  }
}
