Understood. Here’s the **final delta** you should send to the Replit agents—this is the only remaining integrity/value hardening item: **emit `admin_unguarded` when `ADMIN_KEY` is not set**, with **path + ip + ua**, and do it in a way that can’t recurse or break the logbook.

---

## MESSAGE TO REPLIT AGENTS (FINAL DELTA ONLY)

### Goal

Add an **explicit audit warning** whenever any `/api/admin/*` endpoint is accessed in dev **without** `ADMIN_KEY` set.

This protects value by making “unguarded admin access” **forensically visible** in `out/_log/analyzer.ndjson`.

---

### 1) Implement `requireDevAdmin()` to emit `admin_unguarded` when ADMIN_KEY is absent

**Where:** `server/routes.ts` (same file where logbook helpers are)

**Rules:**

* If `NODE_ENV === "production"` → always `403`
* If `ADMIN_KEY` **exists** → require header `x-admin-key` match, else `401`
* If `ADMIN_KEY` **does NOT exist** → allow request **but emit warning event**:

  * `event: "admin_unguarded"`
  * include: `path`, `ip`, `ua`
  * `projectId` can be `0`

**Important constraints:**

* The warning must not crash server even if log write fails.
* The warning should not recurse (do **not** call admin log endpoints inside logging).
* It’s okay if it logs on every request; if you want dedupe later, do it separately.

**Implementation sketch (do exactly this logic):**

* compute:

  * `const ip = req.headers["x-forwarded-for"]?.toString().split(",")[0].trim() || req.socket.remoteAddress || "unknown"`
  * `const ua = req.headers["user-agent"]?.toString() || "unknown"`
  * `const path = req.path`
* If `!process.env.ADMIN_KEY` then:

  * `void logEvent(0, "admin_unguarded", { path, ip, ua })`
  * allow request (return `true`)

---

### 2) Ensure all admin endpoints go through `requireDevAdmin()`

Endpoints:

* `GET /api/admin/analyzer-log`
* `POST /api/admin/analyzer-log/clear`
* `POST /api/admin/reset-analyzer`

Each should begin:

* `if (!(await requireDevAdmin(req, res))) return;`

---

### 3) Verification commands (must paste outputs)

**A) With ADMIN_KEY unset (expect admin_unguarded log):**

```bash
unset ADMIN_KEY
curl -s http://localhost:5000/api/admin/analyzer-log | head -c 80; echo
tail -n 5 out/_log/analyzer.ndjson
```

Expected: request succeeds (dev), and `admin_unguarded` appears with `path/ip/ua`.

**B) With ADMIN_KEY set (no admin_unguarded, key required):**

```bash
export ADMIN_KEY="testkey"
curl -s http://localhost:5000/api/admin/analyzer-log | head -c 80; echo   # expect 401
curl -s http://localhost:5000/api/admin/analyzer-log -H "x-admin-key: testkey" | head -c 80; echo  # expect 200
tail -n 10 out/_log/analyzer.ndjson
```

Expected: 401 without header; 200 with header; **no** `admin_unguarded` emitted in this mode.

---

### Acceptance criteria

* `admin_unguarded` is emitted **only when ADMIN_KEY is not set** (and not in production).
* Contains `path`, `ip`, `ua`.
* Admin endpoints still function normally.
* Logging failures do not affect endpoint behavior.

---
